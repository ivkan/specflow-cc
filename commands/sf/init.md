---
name: sf:init
description: Initialize SpecFlow in current project — analyze codebase and create .specflow/ structure
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
---

<purpose>
Initialize SpecFlow in the current project. Analyzes the codebase to understand tech stack, patterns, and structure, then creates the `.specflow/` directory with PROJECT.md, STATE.md, and config.json.
</purpose>

<context>
@~/.claude/specflow-cc/templates/project.md
@~/.claude/specflow-cc/templates/state.md
</context>

<workflow>

## Step 1: Check if Already Initialized

```bash
[ -d .specflow ] && echo "EXISTS" || echo "NOT_EXISTS"
```

**If EXISTS:**
```
SpecFlow already initialized in this project.

Use `/sf:status` to see current state.
```
Exit.

## Step 2: Detect Tech Stack

Scan for common configuration files:

```bash
# Package managers / Languages
ls package.json pyproject.toml Cargo.toml go.mod pom.xml build.gradle Gemfile composer.json 2>/dev/null

# Frameworks
ls next.config.* nuxt.config.* vite.config.* angular.json vue.config.* 2>/dev/null

# Database
ls prisma/schema.prisma drizzle.config.* knexfile.* 2>/dev/null

# Testing
ls jest.config.* vitest.config.* pytest.ini 2>/dev/null
```

## Step 3: Analyze Project Structure

```bash
# Get top-level structure
ls -la | head -20

# Common source directories
ls -d src app lib pages components 2>/dev/null
```

## Step 4: Detect Patterns

Look for common patterns in the codebase:

```bash
# API routes pattern
ls -d **/api/** app/api pages/api 2>/dev/null | head -5

# Component patterns
ls -d **/components/** 2>/dev/null | head -5

# Check for TypeScript
ls tsconfig.json 2>/dev/null
```

## Step 5: Create .specflow Directory

```bash
mkdir -p .specflow/specs .specflow/audits .specflow/archive .specflow/todos
```

## Step 6: Generate PROJECT.md

Based on detected stack and patterns, create `.specflow/PROJECT.md`:

```markdown
# [Project Name from package.json or directory]

## What This Is

[Infer from README.md if exists, otherwise "Project initialized with SpecFlow"]

## Core Value

[To be defined by user]

## Tech Stack

| Layer | Technology |
|-------|------------|
[Fill based on detection]

## Project Structure

```
[Simplified tree of main directories]
```

## Patterns & Conventions

[List detected patterns]

## Constraints

[To be defined by user]

---
*Generated by SpecFlow on [date]*
```

## Step 7: Generate STATE.md

Create `.specflow/STATE.md`:

```markdown
# SpecFlow State

## Current Position

- **Active Specification:** none
- **Status:** idle
- **Next Step:** /sf:new

## Queue

| # | ID | Title | Priority | Status |
|---|----|-------|----------|--------|

## Decisions

| Date | Specification | Decision |
|------|---------------|----------|

## Project Patterns

[Patterns from PROJECT.md]

## Warnings

| Date | Specification | Reason |
|------|---------------|--------|

---
*Last updated: [date]*
```

## Step 8: Generate config.json

Create `.specflow/config.json`:

```json
{
  "auto_commit": true,
  "commit_format": "feat(sf-{id}): {description}",
  "ask_questions": "critical_only",
  "complexity_threshold": {
    "small": 50000,
    "medium": 150000
  },
  "audit_storage": "hybrid"
}
```

## Step 9: Output Summary

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 SPECFLOW INITIALIZED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**Project:** [name]
**Stack:** [detected technologies]

| File | Purpose |
|------|---------|
| `.specflow/PROJECT.md` | Project overview |
| `.specflow/STATE.md` | Current state |
| `.specflow/config.json` | Configuration |

## Next Step

`/sf:new "your task description"` — create first specification

---

**Tip:** Review `.specflow/PROJECT.md` and fill in:
- Core Value
- Constraints
- Any missing patterns
```

</workflow>

<success_criteria>
- [ ] .specflow/ directory created
- [ ] .specflow/specs/ subdirectory created
- [ ] .specflow/audits/ subdirectory created
- [ ] .specflow/archive/ subdirectory created
- [ ] PROJECT.md created with detected stack
- [ ] STATE.md created with initial state
- [ ] config.json created with defaults
- [ ] User knows next step is /sf:new
</success_criteria>
