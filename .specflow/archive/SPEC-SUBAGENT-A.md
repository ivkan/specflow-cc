# SPEC: Foundation — Auditor Enhancement & Template Changes

---
id: SPEC-SUBAGENT-A
parent: SPEC-SUBAGENT-EXECUTION
type: feature
status: done
priority: high
complexity: small
depends_on: []
created: 2026-01-23
---

> Part 1 of 3 from SPEC-SUBAGENT-EXECUTION (Subagent-Based Execution Model)

## Context

### Problem Statement

Current `spec-executor` runs in a **single context** that accumulates context until exhaustion. Large specifications exhaust context before completion → "Prompt is too long" error.

### This Sub-Spec's Role

This specification establishes the **foundation** for subagent-based execution by:
1. Adding complexity detection to the auditor
2. Enhancing spec template with task decomposition support
3. Introducing `NEEDS_DECOMPOSITION` audit status

Subsequent specs (B, C) will build on this foundation to implement the actual parallel execution.

## Task

Enhance the auditor and spec template to detect when specifications are too large for single-agent execution and need decomposition.

## Requirements

### 1. Auditor Enhancement

Modify `agents/spec-auditor.md` to add **Execution Scope Check** as **Step 3.5** (between "Step 3: Audit Dimensions" and "Step 4: Categorize Issues"):

```markdown
## Step 3.5: Execution Scope Check

Evaluate execution complexity by counting items from the specification content:

| Metric | Value | Threshold | Status |
|--------|-------|-----------|--------|
| Files to create | {N} | ≤5 | ✓/⚠/✗ |
| Files to modify | {N} | ≤3 | ✓/⚠/✗ |
| Acceptance criteria | {N} | ≤10 | ✓/⚠/✗ |
| Total requirements | {N} | ≤15 | ✓/⚠/✗ |

<!-- CONFIGURABLE THRESHOLDS: Adjust values above based on experience.
     These are hardcoded defaults. To change, edit this section directly.
     Future enhancement: move to .specflow/config.md if needed. -->

**Estimated context usage:**
- **small** (~30%): All metrics ≤50% of threshold
- **medium** (~50%): Any metric 50-100% of threshold
- **large** (~80%+): Any metric exceeds threshold

**Status indicators:**
- ✓ OK: Value ≤ threshold
- ⚠ Warning: Value = threshold (at limit)
- ✗ Exceeded: Value > threshold

**Edge case handling:**
- If spec uses vague file references (e.g., "update all test files"), count as **3 files** for estimation
- If spec lists a directory pattern (e.g., "src/handlers/*.ts"), count as **5 files** for estimation
- If files cannot be determined, mark metric as "indeterminate" and default to ⚠ Warning

**If large (>50% estimated):**
- Generate Implementation Tasks section in audit output
- Recommend `/sf:run --parallel` mode
- Set status to NEEDS_DECOMPOSITION (if no critical issues) or note decomposition needed (if other issues)
```

### 2. New Audit Status

Add `NEEDS_DECOMPOSITION` status to Step 5's status table:

```markdown
| Condition | Status |
|-----------|--------|
| No critical issues, small/medium scope | APPROVED |
| No critical issues, large scope | NEEDS_DECOMPOSITION |
| 1+ critical issues | NEEDS_REVISION |
```

Status behavior:
- Triggered when execution scope check shows large estimated context (>50%)
- Indicates spec is valid but too large for single-agent execution
- Recommendation: either split spec OR use orchestrated execution via `/sf:run --parallel`

### 3. Spec Template Enhancement

Modify `templates/spec.md` to add optional `## Implementation Tasks` section (placed between Constraints and Assumptions):

```markdown
## Implementation Tasks

> Optional. Auto-generated by auditor for large specs, or manually added.

### Task Groups

| Group | Tasks | Dependencies | Est. Context |
|-------|-------|--------------|--------------|
| G1 | Create types.ts interfaces | — | ~15% |
| G2 | Create partition-handler.ts | G1 | ~20% |
| G3 | Create topic-handler.ts | G1 | ~20% |
| G4 | Wire handlers in ServerCoordinator | G2, G3 | ~25% |

### Execution Plan

```
Wave 1 (parallel): G1
Wave 2 (parallel): G2, G3
Wave 3 (sequential): G4
```
```

## Files to Modify

| File | Changes |
|------|---------|
| `agents/spec-auditor.md` | Add Step 3.5 (Execution Scope Check), update Step 5 status table to include NEEDS_DECOMPOSITION |
| `templates/spec.md` | Add optional Implementation Tasks section template |

## Acceptance Criteria

1. **Auditor detects large specs**: Specs exceeding thresholds get flagged with NEEDS_DECOMPOSITION status
2. **New status works**: `NEEDS_DECOMPOSITION` appears in audit results when spec passes quality checks but has large scope
3. **Template updated**: New specs can include Implementation Tasks section
4. **Thresholds documented inline**: Threshold values are hardcoded in auditor markdown with comments explaining how to adjust them
5. **Small specs unchanged**: Specs with all metrics within thresholds pass without decomposition warning
6. **Edge cases handled**: Vague file references use conservative estimates (3 files); directory patterns use 5 files; indeterminate metrics default to Warning

## Constraints

- DO NOT change behavior for small/medium specs
- DO NOT require manual task decomposition (auditor can auto-generate)
- DO NOT modify executor behavior (that's in sub-spec B)
- DO NOT require the auditor to read target files (all metrics derived from spec content only)

## Assumptions

- Auditor already reads and analyzes specification structure
- Template system supports optional sections
- Complexity estimation can be done statically from spec content (file counts, criteria counts)

---

## Audit History

### Audit v1 (2026-01-23 14:30)
**Status:** NEEDS_REVISION

**Critical:**
1. **"Thresholds configurable" is undefined** (Acceptance Criterion 4): The spec states thresholds should be configurable but never specifies HOW or WHERE. Are they hardcoded in markdown? Stored in a config file? This requirement cannot be implemented as written.
2. **"Target file max LOC" metric requires file reading**: The auditor currently only reads the specification document. This metric requires the auditor to also read target files mentioned in the spec to count their lines of code. This is a significant behavior change — what files should be read? All listed files? Only existing ones? This needs clarification.

**Recommendations:**
3. Specify WHERE to insert the Execution Scope Check in the auditor's `<process>` section (after Step 3? As Step 3.5? As new Step 4?).
4. Clarify edge case handling: What happens when a spec doesn't list specific files (e.g., "update all test files")? How should the auditor handle indeterminate metrics?
5. Update auditor's Step 5 status table to include NEEDS_DECOMPOSITION alongside APPROVED and NEEDS_REVISION.

### Response v1 (2026-01-23 15:45)
**Applied:** All critical issues and recommendations

**Changes:**
1. [x] **Thresholds configurable** — Changed acceptance criterion 4 to "Thresholds documented inline" with explicit statement that values are hardcoded in auditor markdown with comments. Added HTML comment block in the Execution Scope Check showing how to adjust.
2. [x] **Target file max LOC removed** — Removed the "Target file max LOC" metric entirely from the table since it requires reading files beyond the spec. Added constraint "DO NOT require the auditor to read target files". All metrics now derived from spec content only.
3. [x] **Insertion point specified** — Changed "add Execution Scope Check" to explicitly state "as Step 3.5 (between Step 3: Audit Dimensions and Step 4: Categorize Issues)".
4. [x] **Edge case handling added** — Added "Edge case handling" section specifying: vague references count as 3 files, directory patterns count as 5 files, indeterminate metrics default to Warning. Added acceptance criterion 6 for edge cases.
5. [x] **Status table updated** — Added complete updated Step 5 status table in Requirements section 2, showing APPROVED (small/medium), NEEDS_DECOMPOSITION (large scope), and NEEDS_REVISION (critical issues).

### Audit v2 (2026-01-23 16:00)
**Status:** APPROVED

**Comment:** Specification is well-structured and implementable. All previous critical issues have been addressed. Requirements provide exact markdown content to insert, file locations are explicit, acceptance criteria are measurable, and edge cases are documented. The scope is appropriately limited to foundation work (auditor + template) without overreaching into executor changes.

---

## Execution Summary

**Executed:** 2026-01-23
**Commits:** 2

### Files Modified
- `agents/spec-auditor.md` — Added Step 3.5 (Execution Scope Check) with complexity metrics and thresholds; Updated Step 5 status table to include NEEDS_DECOMPOSITION
- `templates/spec.md` — Added optional Implementation Tasks section with Task Groups and Execution Plan

### Files Created
None

### Files Deleted
None

### Acceptance Criteria Status
- [x] Auditor detects large specs — Step 3.5 with thresholds added
- [x] New status works — NEEDS_DECOMPOSITION added to Step 5 status table
- [x] Template updated — Implementation Tasks section added
- [x] Thresholds documented inline — HTML comment explains how to adjust values
- [x] Small specs unchanged — Status table preserves APPROVED for small/medium scope
- [x] Edge cases handled — Conservative estimates documented (3 files for vague refs, 5 for patterns)

### Deviations
None

### Notes
Implementation followed specification exactly. All markdown content inserted as specified.

---

## Review History

### Review v1 (2026-01-23)
**Result:** APPROVED
**Reviewer:** impl-reviewer (subagent)

**Findings:**

**Minor:**
1. Steps 6, 7, and output template still reference only `[APPROVED | NEEDS_REVISION]` without including `NEEDS_DECOMPOSITION`. While this is technically outside the scope of this specification (which only required updating Step 5's status table), it creates an inconsistency in the auditor's behavior. Future specs (likely SPEC-SUBAGENT-B or C) should address updating these sections to handle the new status.

**Passed:**
- [x] Step 3.5 added at correct location (between Step 3 and Step 4) — lines 117-150 of `agents/spec-auditor.md`
- [x] Step 3.5 content matches specification exactly — metric table, thresholds, status indicators, edge cases all present
- [x] NEEDS_DECOMPOSITION status added to Step 5 status table — line 169 of `agents/spec-auditor.md`
- [x] Status table structure matches specification — APPROVED for small/medium, NEEDS_DECOMPOSITION for large, NEEDS_REVISION for critical issues
- [x] Implementation Tasks section added to template — lines 48-67 of `templates/spec.md`
- [x] Implementation Tasks section placed correctly — between Constraints (line 43) and Assumptions (line 69)
- [x] Task Groups table matches specification
- [x] Execution Plan code block matches specification
- [x] HTML comment for configurable thresholds present (lines 128-130)
- [x] Edge case handling documented (lines 142-145)
- [x] No files created (as expected)
- [x] No files deleted (as expected)
- [x] No security issues
- [x] No code quality issues
- [x] Implementation follows project conventions

**Summary:** Implementation is correct and complete. All specified changes were made exactly as documented. The minor inconsistency noted (Steps 6, 7, and output not updated for NEEDS_DECOMPOSITION) is outside the scope of this specification and should be addressed in subsequent specs.

### Fix Response v1 (2026-01-23)
**Applied:** Minor issue 1 (NEEDS_DECOMPOSITION in Steps 6, 7, output)

**Fixes:**
1. [x] Added NEEDS_DECOMPOSITION to Step 6, 7, and output template in `agents/spec-auditor.md`
   - Step 6: Added status option and section for scope/recommendation
   - Step 7: Added STATE.md update logic for NEEDS_DECOMPOSITION
   - Output: Added NEEDS_DECOMPOSITION section with next step options
   - Commit: 84762d7

### Review v2 (2026-01-23)
**Result:** APPROVED
**Reviewer:** impl-reviewer (subagent)

**Findings:**

**Passed:**
- [x] Fix Response v1 applied correctly — NEEDS_DECOMPOSITION now in Steps 6, 7, and output template
- [x] Step 6 (Record Audit) includes NEEDS_DECOMPOSITION in status options (line 178)
- [x] Step 6 includes scope/recommendation section for NEEDS_DECOMPOSITION (lines 180-182)
- [x] Step 7 (Update STATE.md) includes NEEDS_DECOMPOSITION handling (line 202)
- [x] Output template includes NEEDS_DECOMPOSITION in status options (line 216)
- [x] Output template includes NEEDS_DECOMPOSITION section with next steps (lines 218-230)
- [x] All original acceptance criteria still pass:
  - [x] Auditor detects large specs — Step 3.5 with thresholds (lines 117-150)
  - [x] New status works — NEEDS_DECOMPOSITION in Steps 5, 6, 7, and output
  - [x] Template updated — Implementation Tasks section (lines 48-67 of templates/spec.md)
  - [x] Thresholds documented inline — HTML comment (lines 128-130)
  - [x] Small specs unchanged — APPROVED preserved for small/medium scope (line 168)
  - [x] Edge cases handled — Conservative estimates documented (lines 142-145)
- [x] No files created (as expected)
- [x] No files deleted (as expected)
- [x] No security issues
- [x] Code quality is good — consistent markdown formatting
- [x] Integration is correct — follows auditor document conventions

**Summary:** All fixes from Review v1 have been correctly applied. The NEEDS_DECOMPOSITION status is now consistently handled throughout the auditor (Steps 5, 6, 7, and output template). All original acceptance criteria continue to pass. Implementation is complete and ready for finalization.

---

## Completion

**Completed:** 2026-01-23
**Total Commits:** 2
**Audit Cycles:** 2
**Review Cycles:** 2
